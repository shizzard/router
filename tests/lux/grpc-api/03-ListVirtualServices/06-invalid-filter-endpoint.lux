[doc]
Check if router fails to list registered virtual services with invalid endpoint filter.
[enddoc]

[include ../../__common/common.luxinc]
[include ../../__common/grpc.luxinc]
[include ../../__common/jq.luxinc]
[include ../../__router/registry-service.luxinc]

[global request-file-invalid-host-list=json/06-invalid-host-list-request.json]
[global response-file-invalid-host-list=json/06-invalid-host-list-response.json]
[global request-file-invalid-port-list=json/06-invalid-port-list-request.json]
[global response-file-invalid-port-list=json/06-invalid-port-list-response.json]
[global request-file-invalid-filter-list=json/06-invalid-filter-list-request.json]
[global response-file-invalid-filter-list=json/06-invalid-filter-list-response.json]

[shell router]
  [invoke app-start]

[shell request]
  [progress (list with invalid host)]
  [invoke grpc-call-unary ${service-definition} ${request-file-invalid-host-list} ${response-file-invalid-host-list} ${service-name} ${method-list}]
  [sleep 1]

[shell response]
  [progress (check response)]
  [invoke jq-check-file-match ${response-file-invalid-host-list} .header.\"content-type\" "application/grpc+proto"]
  [invoke jq-check-file-match ${response-file-invalid-host-list} .header.\"grpc-user-agent\" "router/"]
  [invoke jq-check-file-match ${response-file-invalid-host-list} .status.code InvalidArgument]
  [invoke jq-check-file-match ${response-file-invalid-host-list} .status.number 3]
  [invoke jq-check-file-match ${response-file-invalid-host-list} .status.message "Invalid payload"]
  [invoke jq-check-file-match ${response-file-invalid-host-list} .messages null]
  [invoke jq-check-file-match ${response-file-invalid-host-list} .trailer.filter_endpoint_host_empty "Endpoint filter host cannot be empty with non-zero port"]

[shell request]
  [progress (list with invalid port)]
  [invoke grpc-call-unary ${service-definition} ${request-file-invalid-port-list} ${response-file-invalid-port-list} ${service-name} ${method-list}]
  [sleep 1]

[shell response]
  [progress (check response)]
  [invoke jq-check-file-match ${response-file-invalid-port-list} .header.\"content-type\" "application/grpc+proto"]
  [invoke jq-check-file-match ${response-file-invalid-port-list} .header.\"grpc-user-agent\" "router/"]
  [invoke jq-check-file-match ${response-file-invalid-port-list} .status.code InvalidArgument]
  [invoke jq-check-file-match ${response-file-invalid-port-list} .status.number 3]
  [invoke jq-check-file-match ${response-file-invalid-port-list} .status.message "Invalid payload"]
  [invoke jq-check-file-match ${response-file-invalid-port-list} .messages null]
  [invoke jq-check-file-match ${response-file-invalid-port-list} .trailer.filter_endpoint_port_invalid "Endpoint filter port must fall into 1..65535 interval when endpoint filter host is not empty: 0"]

[shell request]
  [progress (list with invalid endpoint filter)]
  [invoke grpc-call-unary ${service-definition} ${request-file-invalid-filter-list} ${response-file-invalid-filter-list} ${service-name} ${method-list}]
  [sleep 1]

[shell response]
  [progress (check response)]
  [invoke jq-check-file-match ${response-file-invalid-filter-list} .header.\"content-type\" "application/grpc+proto"]
  [invoke jq-check-file-match ${response-file-invalid-filter-list} .header.\"grpc-user-agent\" "router/"]
  [invoke jq-check-file-match ${response-file-invalid-filter-list} .status.code InvalidArgument]
  [invoke jq-check-file-match ${response-file-invalid-filter-list} .status.number 3]
  [invoke jq-check-file-match ${response-file-invalid-filter-list} .status.message "Invalid payload"]
  [invoke jq-check-file-match ${response-file-invalid-filter-list} .messages null]
  [invoke jq-check-file-match ${response-file-invalid-filter-list} .trailer.filter_endpoint_host_empty "Endpoint filter host cannot be empty with non-zero port"]
  [invoke jq-check-file-match ${response-file-invalid-filter-list} .trailer.filter_endpoint_port_invalid "Endpoint filter port must fall into 1..65535 interval when endpoint filter host is not empty: 81370"]

[cleanup]
