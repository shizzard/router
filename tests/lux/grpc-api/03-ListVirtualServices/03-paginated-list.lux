[doc]
Check if router replies with a paginated list of registered virtual services.
[enddoc]

[include ../../__common/common.luxinc]
[include ../../__common/grpc.luxinc]
[include ../../__common/jq.luxinc]
[include ../../__router/registry-service.luxinc]

[global request-file-service-A1-register=json/00-service-A1-register-request.json]
[global response-file-service-A1-register=json/00-service-A1-register-response.json]
[global request-file-service-A2-register=json/00-service-A2-register-request.json]
[global response-file-service-A2-register=json/00-service-A2-register-response.json]
[global request-file-service-B1-register=json/00-service-B1-register-request.json]
[global response-file-service-B1-register=json/00-service-B1-register-response.json]
[global request-file-service-B2-register=json/00-service-B2-register-request.json]
[global response-file-service-B2-register=json/00-service-B2-register-response.json]
[global request-file-service-C1-register=json/00-service-C1-register-request.json]
[global response-file-service-C1-register=json/00-service-C1-register-response.json]
[global request-file-list-1=json/03-list-request-1.json]
[global response-file-list-1=json/03-list-response-1.json]
[global template-file-list-2=json/03-list-request-2.template.json]
[global request-file-list-2=json/03-list-request-2.json]
[global response-file-list-2=json/03-list-response-2.json]

[shell router]
  [invoke app-start]

[shell request]
  [progress (register services)]
  [invoke grpc-call-unary ${service-definition} ${request-file-service-A1-register} ${response-file-service-A1-register} ${service-name} ${method-register}]
  [invoke grpc-call-unary ${service-definition} ${request-file-service-A2-register} ${response-file-service-A2-register} ${service-name} ${method-register}]
  [invoke grpc-call-unary ${service-definition} ${request-file-service-B1-register} ${response-file-service-B1-register} ${service-name} ${method-register}]
  [invoke grpc-call-unary ${service-definition} ${request-file-service-B2-register} ${response-file-service-B2-register} ${service-name} ${method-register}]
  [invoke grpc-call-unary ${service-definition} ${request-file-service-C1-register} ${response-file-service-C1-register} ${service-name} ${method-register}]
  [sleep 1]

[shell request]
  [progress (list first page)]
  [invoke grpc-call-unary ${service-definition} ${request-file-list-1} ${response-file-list-1} ${service-name} ${method-list}]
  [sleep 1]

[shell response]
  [progress (check response)]
  [invoke jq-check-file-match ${response-file-list-1} .header.\"content-type\" "application/grpc+proto"]
  [invoke jq-check-file-match ${response-file-list-1} .header.\"grpc-user-agent\" "router/"]
  [invoke jq-check-file-match ${response-file-list-1} .status.code OK]
  [invoke jq-check-file-match ${response-file-list-1} .status.number 0]
  [invoke jq-check-file-match ${response-file-list-1} ".messages[0].services | length" 3]
  [invoke jq-check-file-match ${response-file-list-1} .messages[0].services[0].stateless.package lg.test.package]
  [invoke jq-check-file-match ${response-file-list-1} .messages[0].services[0].stateless.name StatelessServiceA]
  [invoke jq-check-file-match ${response-file-list-1} .messages[0].services[0].stateless.methods[0].name MethodOne]
  [invoke jq-check-file-match ${response-file-list-1} .messages[0].services[0].endpoint.host "test-1.lg"]
  [invoke jq-check-file-match ${response-file-list-1} .messages[0].services[0].endpoint.port 8137]
  [invoke jq-check-file-match ${response-file-list-1} .messages[0].services[1].stateless.package lg.test.package]
  [invoke jq-check-file-match ${response-file-list-1} .messages[0].services[1].stateless.name StatelessServiceA]
  [invoke jq-check-file-match ${response-file-list-1} .messages[0].services[1].stateless.methods[0].name MethodOne]
  [invoke jq-check-file-match ${response-file-list-1} .messages[0].services[1].endpoint.host "test-2.lg"]
  [invoke jq-check-file-match ${response-file-list-1} .messages[0].services[1].endpoint.port 8137]
  [invoke jq-check-file-match ${response-file-list-1} .messages[0].services[2].stateless.package lg.test.package]
  [invoke jq-check-file-match ${response-file-list-1} .messages[0].services[2].stateless.name StatelessServiceB]
  [invoke jq-check-file-match ${response-file-list-1} .messages[0].services[2].stateless.methods[0].name MethodOne]
  [invoke jq-check-file-match ${response-file-list-1} .messages[0].services[2].endpoint.host "test-1.lg"]
  [invoke jq-check-file-match ${response-file-list-1} .messages[0].services[2].endpoint.port 8137]
  [invoke jq-check-file ${response-file-list-1} .messages[0].paginationResponse.nextPageToken]
  ?^([A-Za-z0-9=/]+)$
  [global next-page-token=$1]
  [progress (next-page-token ${next-page-token})]
  [invoke jq-check-file-match ${response-file-list-1} .trailer "{}"]

[shell request]
  [progress (prepare list second page request)]
  !sed 's~%PLACEHOLDER%~${next-page-token}~' ${template-file-list-2} > ${request-file-list-2}
  [progress (list second page)]
  [invoke grpc-call-unary ${service-definition} ${request-file-list-2} ${response-file-list-2} ${service-name} ${method-list}]
  [sleep 1]


[shell response]
  [progress (check response)]
  [invoke jq-check-file-match ${response-file-list-2} .header.\"content-type\" "application/grpc+proto"]
  [invoke jq-check-file-match ${response-file-list-2} .header.\"grpc-user-agent\" "router/"]
  [invoke jq-check-file-match ${response-file-list-2} .status.code OK]
  [invoke jq-check-file-match ${response-file-list-2} .status.number 0]
  [invoke jq-check-file-match ${response-file-list-2} ".messages[0].services | length" 2]
  [invoke jq-check-file-match ${response-file-list-2} .messages[0].services[0].stateless.package lg.test.package]
  [invoke jq-check-file-match ${response-file-list-2} .messages[0].services[0].stateless.name StatelessServiceB]
  [invoke jq-check-file-match ${response-file-list-2} .messages[0].services[0].stateless.methods[0].name MethodOne]
  [invoke jq-check-file-match ${response-file-list-2} .messages[0].services[0].endpoint.host "test-2.lg"]
  [invoke jq-check-file-match ${response-file-list-2} .messages[0].services[0].endpoint.port 8137]
  [invoke jq-check-file-match ${response-file-list-2} .messages[0].services[1].stateless.package lg.test.package]
  [invoke jq-check-file-match ${response-file-list-2} .messages[0].services[1].stateless.name StatelessServiceC]
  [invoke jq-check-file-match ${response-file-list-2} .messages[0].services[1].stateless.methods[0].name MethodOne]
  [invoke jq-check-file-match ${response-file-list-2} .messages[0].services[1].endpoint.host "test-1.lg"]
  [invoke jq-check-file-match ${response-file-list-2} .messages[0].services[1].endpoint.port 8137]
  [invoke jq-check-file-match ${response-file-list-2} .messages[0].paginationResponse.nextPageToken null]
  [invoke jq-check-file-match ${response-file-list-2} .trailer "{}"]

[cleanup]
