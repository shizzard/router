[doc]
Check if router fails to unregister a gRPC virtual service with empty or restricted package.
[enddoc]

[include ../../__common/common.luxinc]
[include ../../__common/grpc.luxinc]
[include ../../__common/jq.luxinc]

[global service-definition=lg/service/router/registry.proto]
[global request-file-empty=json/02-empty-package-request.json]
[global response-file-empty=json/02-empty-package-response.json]
[global request-file-restricted=json/02-restricted-package-request.json]
[global response-file-restricted=json/02-restricted-package-response.json]
[global service=lg.service.router.RegistryService]
[global method=UnregisterVirtualService]

[shell router]
  [invoke app-start]

[shell request]
  [progress (register with empty package)]
  [invoke grpc-call-unary ${service-definition} ${request-file-empty} ${response-file-empty} ${service} ${method}]
  [sleep 1]

[shell response]
  [progress (check response)]
  [invoke jq-check-file-match ${response-file-empty} .header.\"content-type\" "application/grpc+proto"]
  [invoke jq-check-file-match ${response-file-empty} .header.\"grpc-user-agent\" "router/"]
  [invoke jq-check-file-match ${response-file-empty} .status.code InvalidArgument]
  [invoke jq-check-file-match ${response-file-empty} .status.number 3]
  [invoke jq-check-file-match ${response-file-empty} .status.message "Invalid payload"]
  [invoke jq-check-file-match ${response-file-empty} .messages null]
  [invoke jq-check-file-match ${response-file-empty} .trailer.package_empty "Virtual service package cannot be empty"]

[shell request]
  [progress (register with restricted package)]
  [invoke grpc-call-unary ${service-definition} ${request-file-restricted} ${response-file-restricted} ${service} ${method}]
  [sleep 1]

[shell response]
  [progress (check response)]
  [invoke jq-check-file-match ${response-file-restricted} .header.\"content-type\" "application/grpc+proto"]
  [invoke jq-check-file-match ${response-file-restricted} .header.\"grpc-user-agent\" "router/"]
  [invoke jq-check-file-match ${response-file-restricted} .status.code InvalidArgument]
  [invoke jq-check-file-match ${response-file-restricted} .status.number 3]
  [invoke jq-check-file-match ${response-file-restricted} .status.message "Invalid payload"]
  [invoke jq-check-file-match ${response-file-restricted} .messages null]
  [invoke jq-check-file-match ${response-file-restricted} .trailer.package_restricted "Virtual service package is restricted: lg.service.router"]

[cleanup]
  !rm ${response-file-empty}
  !rm ${response-file-restricted}
