[doc]
Check if router fails to list registered virtual services with invalid endpoint filter.
[enddoc]

[include ${ROUTER_DIR_TESTS_LUX}/__common/common.luxinc]
[include ${ROUTER_DIR_TESTS_LUX}/__common/grpc.luxinc]
[include ${ROUTER_DIR_TESTS_LUX}/__common/jq.luxinc]
[include ${ROUTER_DIR_TESTS_LUX}/__router/registry-service.luxinc]

[global request-file-invalid-host-list=json/invalid-host-list-request.json]
[global request-file-invalid-port-list=json/invalid-port-list-request.json]
[global request-file-invalid-filter-list=json/invalid-filter-list-request.json]

[shell router]
  [invoke app-start]

[shell invalid-filter-host]
  [progress (list with invalid host filter)]
  [invoke grpcc-start-unary-nodata ${grpc-service-name} ${grpc-method-list-virtual-services} "json" "" ${request-file-invalid-host-list}]
  [progress (check response)]
  [invoke jq-check-file-match ${headers} .headers.\"content-type\" "application/grpc+proto"]
  [invoke jq-check-file-match ${headers} .headers.\"grpc-user-agent\" "router/"]
  [invoke jq-check-file-match ${headers} .status 200]
  [invoke jq-check-file-match ${trailers} .trailers.\"grpc-status\" 3]
  [invoke jq-check-file-match ${trailers} .trailers.\"grpc-message\" "Invalid payload"]
  [invoke jq-check-file-match ${trailers} .trailers.\"filter_endpoint_host_empty\" "Endpoint filter host cannot be empty with non-zero port"]

[shell invalid-filter-port]
  [progress (list with invalid port filter)]
  [invoke grpcc-start-unary-nodata ${grpc-service-name} ${grpc-method-list-virtual-services} "json" "" ${request-file-invalid-port-list}]
  [progress (check response)]
  [invoke jq-check-file-match ${headers} .headers.\"content-type\" "application/grpc+proto"]
  [invoke jq-check-file-match ${headers} .headers.\"grpc-user-agent\" "router/"]
  [invoke jq-check-file-match ${headers} .status 200]
  [invoke jq-check-file-match ${trailers} .trailers.\"grpc-status\" 3]
  [invoke jq-check-file-match ${trailers} .trailers.\"grpc-message\" "Invalid payload"]
  [invoke jq-check-file-match ${trailers} .trailers.\"filter_endpoint_port_invalid\" "Endpoint filter port must fall into 1..65535 interval when endpoint filter host is not empty: 0"]

[shell invalid-filter]
  [progress (list with invalid filter)]
  [invoke grpcc-start-unary-nodata ${grpc-service-name} ${grpc-method-list-virtual-services} "json" "" ${request-file-invalid-filter-list}]
  [progress (check response)]
  [invoke jq-check-file-match ${headers} .headers.\"content-type\" "application/grpc+proto"]
  [invoke jq-check-file-match ${headers} .headers.\"grpc-user-agent\" "router/"]
  [invoke jq-check-file-match ${headers} .status 200]
  [invoke jq-check-file-match ${trailers} .trailers.\"grpc-status\" 3]
  [invoke jq-check-file-match ${trailers} .trailers.\"grpc-message\" "Invalid payload"]
  [invoke jq-check-file-match ${trailers} .trailers.\"filter_endpoint_host_empty\" "Endpoint filter host cannot be empty with non-zero port"]
  [invoke jq-check-file-match ${trailers} .trailers.\"filter_endpoint_port_invalid\" "Endpoint filter port must fall into 1..65535 interval when endpoint filter host is not empty: 81370"]

[cleanup]
